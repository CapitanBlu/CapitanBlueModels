<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector Pro | CapitanBlue</title>
    <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #050508; --panel: rgba(20, 20, 25, 0.95); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        model-viewer { width: 100%; height: 100vh; background: radial-gradient(circle at 50% 40%, #1a1a2e 0%, #050508 100%); }
        .header { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 100; box-sizing: border-box; }
        .back-link { text-decoration: none; color: white; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; backdrop-filter: blur(10px); pointer-events: auto; }
        .inspector { position: absolute; right: 20px; top: 80px; width: 260px; background: var(--panel); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        h4 { font-size: 0.65rem; color: var(--accent); text-transform: uppercase; margin-top: 20px; border-bottom: 1px solid #333; }
        .stats-chip { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 8px; font-size: 10px; color: var(--accent); font-family: monospace; }
        .btn-mode { background: #111; border: 1px solid #333; color: #777; padding: 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-bottom: 5px; }
        .btn-mode.active { background: var(--accent); color: black; }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-link">← VOLVER</a>
        <div id="model-name" style="font-weight: 800; color: var(--accent);">CONECTANDO...</div>
    </div>

    <div class="inspector">
        <h4>Visualización</h4>
        <button class="btn-mode active" id="m-final" onclick="updateRender('final')">LIT (FINAL)</button>
        <button class="btn-mode" id="m-wire" onclick="updateRender('wire')">WIREFRAME</button>
        <button class="btn-mode" id="m-clay" onclick="updateRender('clay')">CLAY MODE</button>
        
        <h4>Exposición</h4>
        <input type="range" min="0" max="3" step="0.1" value="1" style="width:100%" oninput="viewer.exposure = this.value">
    </div>

    <div class="stats-chip" id="stats">CARGANDO GEOMETRÍA...</div>

    <model-viewer id="main-visor" src="" camera-controls auto-rotate shadow-intensity="1" environment-image="neutral" loading="eager"></model-viewer>

    <script>
        const viewer = document.querySelector("#main-visor");
        let originalMaterials = new Map();

        // 1. OBTENER URL LFS DESDE EL INDEX
        const params = new URLSearchParams(window.location.search);
        const modelUrl = params.get('model');
        
        if(modelUrl) {
            viewer.src = decodeURIComponent(modelUrl);
        }

        // 2. MOSTRAR PROGRESO (Vital para archivos grandes)
        viewer.addEventListener('progress', (ev) => {
            const percent = Math.round(ev.detail.totalProgress * 100);
            document.querySelector("#model-name").innerText = `DESCARGANDO: ${percent}%`;
        });

        // 3. PROCESAR MODELO AL CARGAR
        viewer.addEventListener('load', () => {
            document.querySelector("#model-name").innerText = "INSPECTOR ACTIVO";
            const scene = viewer.toObject3D();
            let polys = 0;

            scene.traverse(node => {
                if (node.isMesh) {
                    originalMaterials.set(node.uuid, node.material.clone());
                    polys += node.geometry.index ? node.geometry.index.count / 3 : node.geometry.attributes.position.count / 3;
                    
                    // Capa Wireframe
                    const wireGeo = new THREE.WireframeGeometry(node.geometry);
                    const wireframe = new THREE.LineSegments(wireGeo, new THREE.LineBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.3 }));
                    wireframe.name = "wireframe_layer";
                    wireframe.visible = false;
                    node.add(wireframe);
                }
            });
            document.getElementById('stats').innerText = `POLÍGONOS: ${Math.round(polys).toLocaleString()}`;
        });

        function updateRender(mode) {
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById(`m-${mode}`).classList.add('active');
            const scene = viewer.toObject3D();
            scene.traverse(node => {
                if (node.isMesh) {
                    const wire = node.children.find(c => c.name === "wireframe_layer");
                    if (wire) wire.visible = (mode === 'wire');
                    if (mode === 'clay') node.material = new THREE.MeshStandardMaterial({ color: 0x666666, roughness: 0.8 });
                    else if (mode === 'final') node.material = originalMaterials.get(node.uuid);
                }
            });
        }
    </script>
</body>
</html>
