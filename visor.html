<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector Pro | CapitanBlue</title>
    
    <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        :root {
            --accent: #00d4ff;
            --bg: #0a0a0f;
            --panel: rgba(15, 15, 20, 0.95);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }

        model-viewer { width: 100%; height: 100vh; --poster-color: transparent; background: radial-gradient(circle at 50% 40%, #1a1a2e 0%, #050508 100%); }

        /* UI SUPERIOR */
        .header { position: absolute; top: 0; width: 100%; padding: 25px; display: flex; justify-content: space-between; align-items: center; z-index: 100; pointer-events: none; }
        .back-link { pointer-events: auto; text-decoration: none; color: #666; font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; transition: 0.3s; border: 1px solid #333; padding: 8px 15px; border-radius: 5px; }
        .back-link:hover { color: var(--accent); border-color: var(--accent); background: rgba(0,212,255,0.05); }

        /* INSPECTOR LATERAL */
        .inspector {
            position: absolute; right: 20px; top: 80px; width: 280px;
            background: var(--panel); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 20px; backdrop-filter: blur(15px);
            z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .inspector h4 { margin: 0 0 15px 0; font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        
        .control-group { margin-bottom: 18px; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 8px; color: #888; }
        
        /* BOTONES ESTILO SKETCHFAB */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-mode { 
            background: #1a1a1a; border: 1px solid #333; 
            color: #888; padding: 10px; border-radius: 6px; font-size: 0.65rem; 
            cursor: pointer; transition: 0.2s; font-weight: 600;
        }
        .btn-mode:hover { border-color: #555; color: white; }
        .btn-mode.active { background: var(--accent); color: black; border-color: var(--accent); }

        /* INPUTS */
        input[type="range"] { width: 100%; accent-color: var(--accent); height: 4px; cursor: pointer; }

        /* STATS */
        .stats-chip {
            position: absolute; bottom: 25px; left: 25px;
            background: rgba(0,0,0,0.8); padding: 10px 18px; border-radius: 6px;
            font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--accent);
            border: 1px solid rgba(0,212,255,0.2); pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-link">← VOLVER AL PORTAFOLIO</a>
        <h2 id="model-name" style="margin:0; font-size: 0.9rem; font-weight: 800; color: white;">MODELO 3D</h2>
    </div>

    <div class="inspector">
        <h4>Renderizado</h4>
        <div class="control-group">
            <div class="mode-grid">
                <button class="btn-mode active" id="m-final" onclick="setMode('final')">Final</button>
                <button class="btn-mode" id="m-wire" onclick="setMode('wire')">Wireframe</button>
                <button class="btn-mode" id="m-clay" onclick="setMode('clay')">Clay</button>
                <button class="btn-mode" id="m-uv" onclick="setMode('uv')">Check UV</button>
            </div>
        </div>

        <h4>Iluminación</h4>
        <div class="control-group">
            <div class="label-row"><span>Intensidad</span> <span id="val-exp">1.0</span></div>
            <input type="range" min="0" max="2" step="0.1" value="1" oninput="updateExp(this.value)">
        </div>

        <div class="control-group">
            <div class="label-row"><span>Ambiente (HDR)</span></div>
            <select id="env-select" class="btn-mode" style="width:100%" onchange="updateEnv(this.value)">
                <option value="neutral">Estudio Neutro</option>
                <option value="https://modelviewer.dev/shared-assets/environments/spruit_sunrise_1k_hdr.hdr">Amanecer</option>
                <option value="https://modelviewer.dev/shared-assets/environments/aircraft_workshop_01_1k.hdr">Taller</option>
                <option value="https://modelviewer.dev/shared-assets/environments/moonlight_1k.hdr">Noche / Luna</option>
            </select>
        </div>
    </div>

    <div class="stats-chip" id="stats">
        POLYS: CALC... | VERTS: CALC...
    </div>

    <model-viewer id="main-visor" 
        src="" 
        camera-controls 
        auto-rotate
        shadow-intensity="1" 
        environment-image="neutral"
        exposure="1"
        camera-orbit="45deg 75deg 105%"
        interaction-prompt="none">
    </model-viewer>

    <script>
        const viewer = document.querySelector("#main-visor");
        const statsDisplay = document.querySelector("#stats");
        let wireframes = [];
        let backupMaterials = [];

        const params = new URLSearchParams(window.location.search);
        const model = params.get('model');
        if(model) {
            viewer.src = `modelos/${model}`;
            document.querySelector("#model-name").innerText = model.split('.')[0].toUpperCase();
        }

        // --- LÓGICA DE DETECCIÓN Y REPARACIÓN ---
        viewer.addEventListener('load', () => {
            const scene = viewer.toObject3D(); // Forma oficial de obtener la escena
            
            let polys = 0;
            let verts = 0;
            wireframes = [];
            backupMaterials = [];

            scene.traverse(node => {
                if (node.isMesh) {
                    // 1. Calcular Stats
                    polys += node.geometry.index ? node.geometry.index.count / 3 : node.geometry.attributes.position.count / 3;
                    verts += node.geometry.attributes.position.count;

                    // 2. Crear Wireframe Real
                    const geo = new THREE.WireframeGeometry(node.geometry);
                    const mat = new THREE.LineBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.6 });
                    const wire = new THREE.LineSegments(geo, mat);
                    node.add(wire);
                    wire.visible = false;
                    wireframes.push(wire);

                    // 3. Backup de materiales para modo Clay/UV
                    backupMaterials.push({
                        mesh: node,
                        original: node.material.clone()
                    });
                }
            });

            statsDisplay.innerText = `POLYS: ${Math.round(polys).toLocaleString()} | VERTS: ${Math.round(verts).toLocaleString()}`;
        });

        function setMode(mode) {
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById(`m-${mode}`).classList.add('active');

            wireframes.forEach(w => w.visible = (mode === 'wire'));

            backupMaterials.forEach(entry => {
                if (mode === 'clay') {
                    entry.mesh.material = new THREE.MeshStandardMaterial({ color: 0x777777, roughness: 0.4 });
                } else if (mode === 'uv') {
                    entry.mesh.material = new THREE.MeshStandardMaterial({ color: 0x00ffaa, wireframe: true });
                } else {
                    entry.mesh.material = entry.original;
                }
            });
        }

        function updateExp(val) {
            viewer.exposure = val;
            document.getElementById('val-exp').innerText = val;
        }

        function updateEnv(val) {
            viewer.environmentImage = val;
        }
    </script>
</body>
</html>
