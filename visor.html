<script>
    const viewer = document.querySelector("#main-visor");
    let originalMaterials = new Map();

    // --- CONFIGURACIÓN DE TU REPOSITORIO ---
    const GITHUB_USER = "TU_USUARIO"; // Pon aquí tu nombre de usuario de GitHub
    const GITHUB_REPO = "TU_REPOSITORIO"; // Pon aquí el nombre de tu proyecto

    // 1. CARGA INTELIGENTE (LOCAL O LFS)
    const params = new URLSearchParams(window.location.search);
    const modelParam = params.get('model');
    
    if(modelParam) {
        let fileName = decodeURIComponent(modelParam);
        
        // Limpiamos el nombre si trae la ruta completa
        let cleanName = fileName.replace('modelos/', '');
        
        // CONSTRUIMOS LA URL DE MEDIA PARA LFS
        // Esto obliga a GitHub a entregar el archivo real, no el puntero de texto
        const lfsPath = `https://media.githubusercontent.com/media/${GITHUB_USER}/${GITHUB_REPO}/main/modelos/${cleanName}`;
        
        viewer.src = lfsPath;
        document.querySelector("#model-name").innerText = "DESCARGANDO: " + cleanName.toUpperCase();
    }

    // 2. BARRA DE CARGA REAL (Para archivos de 100MB)
    viewer.addEventListener('progress', (event) => {
        const percent = Math.round(event.detail.totalProgress * 100);
        document.querySelector("#model-name").innerText = `CARGANDO: ${percent}%`;
        if(percent === 100) document.querySelector("#model-name").innerText = "PROCESANDO GEOMETRÍA...";
    });

    // 3. ANALISIS DE MALLA Y PREPARACIÓN DE MODOS
    viewer.addEventListener('load', () => {
        document.querySelector("#model-name").innerText = "INSPECTOR ACTIVE";
        const scene = viewer.toObject3D();
        let polys = 0;
        let verts = 0;

        scene.traverse(node => {
            if (node.isMesh) {
                originalMaterials.set(node.uuid, node.material.clone());
                
                polys += node.geometry.index ? node.geometry.index.count / 3 : node.geometry.attributes.position.count / 3;
                verts += node.geometry.attributes.position.count;

                const wireGeo = new THREE.WireframeGeometry(node.geometry);
                const wireMat = new THREE.LineBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.3 });
                const wireframe = new THREE.LineSegments(wireGeo, wireMat);
                wireframe.name = "wireframe_layer";
                wireframe.visible = false;
                node.add(wireframe);
            }
        });

        document.getElementById('stats').innerText = `POLYS: ${Math.round(polys).toLocaleString()} | VERTS: ${Math.round(verts).toLocaleString()}`;
    });

    // 4. SWITCH DE RENDERIZADO
    function updateRender(mode) {
        document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
        document.getElementById(`m-${mode}`).classList.add('active');

        const scene = viewer.toObject3D();
        scene.traverse(node => {
            if (node.isMesh) {
                const wireLayer = node.children.find(c => c.name === "wireframe_layer");
                if (wireLayer) wireLayer.visible = (mode === 'wire');
                
                if (mode === 'clay') {
                    node.material = new THREE.MeshStandardMaterial({ color: 0x666666, roughness: 0.8 });
                } else if (mode === 'uv') {
                    node.material = new THREE.MeshStandardMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.2 });
                } else {
                    node.material = originalMaterials.get(node.uuid);
                }
            }
        });
    }

    // 5. FILTROS CSS
    function applyFilters() {
        const b = document.getElementById('p-bright').value;
        const c = document.getElementById('p-contrast').value;
        const s = document.getElementById('p-saturate').value;
        viewer.style.filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;
    }
</script>
