<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapitanBlue | 3D Inspector</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --accent: #00d4ff;
            --bg-dark: #0a0a0b;
            --glass: rgba(15, 15, 18, 0.85);
            --border: rgba(255, 255, 255, 0.1);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: 'Inter', sans-serif; color: white;
            overflow: hidden;
        }

        /* El Visor principal */
        model-viewer {
            width: 100%; height: 100vh;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #050508 100%);
            --progress-bar-color: var(--accent);
        }

        /* Header Estilo Sketchfab */
        .ui-header {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 20px 30px; display: flex; justify-content: space-between;
            align-items: center; z-index: 100; box-sizing: border-box;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .model-title {
            display: flex; flex-direction: column; gap: 4px;
        }

        .model-title h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: white; letter-spacing: 0.5px; }
        .model-title span { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }

        .btn-back {
            text-decoration: none; color: #ccc; font-size: 0.8rem;
            background: var(--glass); padding: 8px 16px; border-radius: 6px;
            border: 1px solid var(--border); transition: 0.3s;
        }
        .btn-back:hover { background: white; color: black; }

        /* Panel Lateral de Herramientas */
        .side-menu {
            position: absolute; right: 20px; top: 80px; width: 220px;
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 12px;
            padding: 15px; z-index: 100;
        }

        .tool-group { margin-bottom: 20px; }
        .tool-group label { 
            display: block; font-size: 0.65rem; color: #888; 
            text-transform: uppercase; margin-bottom: 10px; font-weight: 800;
        }

        .btn-tool {
            width: 100%; padding: 10px; margin-bottom: 6px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: #eee; border-radius: 6px; cursor: pointer;
            text-align: left; font-size: 0.75rem; display: flex; align-items: center; gap: 10px;
            transition: 0.2s;
        }

        .btn-tool:hover { background: rgba(255,255,255,0.15); }
        .btn-tool.active { background: var(--accent); color: black; font-weight: 700; }

        /* Estadísticas e Información (Abajo Izquierda) */
        .info-stats {
            position: absolute; bottom: 20px; left: 20px;
            background: var(--glass); padding: 10px 15px;
            border-radius: 8px; border: 1px solid var(--border);
            font-family: monospace; font-size: 10px; line-height: 1.5;
        }

        .stat-line { display: flex; justify-content: space-between; gap: 20px; }
        .stat-label { color: #888; }
        .stat-value { color: var(--accent); }

        /* Barra de Carga Personalizada */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 40px; height: 40px; border: 3px solid #333;
            border-top: 3px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loader">
        <div class="loader"></div>
        <div id="load-text" style="font-size: 0.8rem; font-weight: 800;">INICIALIZANDO ASSET...</div>
    </div>

    <div class="ui-header">
        <div class="model-title">
            <span id="category">Asset 3D High Quality</span>
            <h1 id="model-name-display">MODELO LOCAL</h1>
        </div>
        <a href="index.html" class="btn-back"><i class="fas fa-chevron-left"></i> VOLVER</a>
    </div>

    <div class="side-menu">
        <div class="tool-group">
            <label>Renderizado</label>
            <button class="btn-tool active" id="btn-final" onclick="setMode('final')"><i class="fas fa-cube"></i> Final Render</button>
            <button class="btn-tool" id="btn-wire" onclick="setMode('wire')"><i class="fas fa-project-diagram"></i> Wireframe</button>
            <button class="btn-tool" id="btn-clay" onclick="setMode('clay')"><i class="fas fa-paint-roller"></i> Clay Mode</button>
        </div>

        <div class="tool-group">
            <label>Iluminación / Exposición</label>
            <input type="range" min="0" max="2" step="0.01" value="1" style="width: 100%; accent-color: var(--accent);" oninput="document.querySelector('#main-visor').exposure = this.value">
        </div>

        <div class="tool-group">
            <label>Entorno</label>
            <button class="btn-tool" onclick="document.querySelector('#main-visor').environmentImage = 'neutral'"><i class="fas fa-sun"></i> Studio Neutral</button>
            <button class="btn-tool" onclick="document.querySelector('#main-visor').environmentImage = 'legacy'"><i class="fas fa-cloud-sun"></i> Exterior HDRI</button>
        </div>
    </div>

    <div class="info-stats">
        <div class="stat-line"><span class="stat-label">VÉRTICES:</span> <span class="stat-value" id="count-verts">-</span></div>
        <div class="stat-line"><span class="stat-label">TRIÁNGULOS:</span> <span class="stat-value" id="count-tris">-</span></div>
        <div class="stat-line"><span class="stat-label">STATUS:</span> <span class="stat-value" style="color: #00ff00;">OPTIMIZADO</span></div>
    </div>

    <model-viewer id="main-visor"
        src=""
        camera-controls
        auto-rotate
        shadow-intensity="1.5"
        shadow-softness="0.5"
        environment-image="neutral"
        exposure="1"
        loading="eager"
        draco-decoder-path="https://www.gstatic.com/draco/versioned/decoders/1.5.6/"
        power-preference="high-performance">
    </model-viewer>

    <script>
        const viewer = document.querySelector("#main-visor");
        const loader = document.getElementById('loader');
        const loadText = document.getElementById('load-text');
        let originalMaterials = new Map();

        // 1. Cargar el modelo desde la URL
        const params = new URLSearchParams(window.location.search);
        const modelUrl = params.get('model');
        
        if(modelUrl) {
            viewer.src = decodeURIComponent(modelUrl);
            const fileName = modelUrl.split('/').pop().replace('.glb', '').toUpperCase();
            document.getElementById('model-name-display').innerText = fileName;
        }

        // 2. Control de Carga
        viewer.addEventListener('progress', (ev) => {
            const percent = Math.round(ev.detail.totalProgress * 100);
            loadText.innerText = `DESCARGANDO: ${percent}%`;
            if(percent >= 100) loadText.innerText = "PROCESANDO GEOMETRÍA...";
        });

        viewer.addEventListener('load', () => {
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);

            // Analizar escena para Wireframe y Stats
            const scene = viewer.toObject3D();
            let tris = 0;
            let verts = 0;

            scene.traverse(node => {
                if (node.isMesh) {
                    // Guardar material original
                    originalMaterials.set(node.uuid, node.material.clone());
                    
                    // Contar Polígonos
                    const geo = node.geometry;
                    tris += geo.index ? geo.index.count / 3 : geo.attributes.position.count / 3;
                    verts += geo.attributes.position.count;

                    // Crear capa Wireframe (estilo Sketchfab)
                    const wireframe = new THREE.LineSegments(
                        new THREE.WireframeGeometry(geo),
                        new THREE.LineBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.3 })
                    );
                    wireframe.name = "wf_layer";
                    wireframe.visible = false;
                    node.add(wireframe);
                }
            });

            document.getElementById('count-tris').innerText = Math.round(tris).toLocaleString();
            document.getElementById('count-verts').innerText = Math.round(verts).toLocaleString();
        });

        // 3. Modos de Visualización
        window.setMode = (mode) => {
            // Actualizar botones UI
            document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            const scene = viewer.toObject3D();
            scene.traverse(node => {
                if (node.isMesh) {
                    const wf = node.children.find(c => c.name === "wf_layer");
                    
                    if(mode === 'final') {
                        node.material = originalMaterials.get(node.uuid);
                        if(wf) wf.visible = false;
                    } else if(mode === 'wire') {
                        node.material = new THREE.MeshStandardMaterial({ color: 0x000000 });
                        if(wf) wf.visible = true;
                    } else if(mode === 'clay') {
                        node.material = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.8 });
                        if(wf) wf.visible = false;
                    }
                }
            });
        };

        // Manejo de Errores
        viewer.addEventListener('error', (e) => {
            loadText.innerText = "ERROR: ARCHIVO DEMASIADO PESADO O INCOMPATIBLE";
            loadText.style.color = "red";
        });
    </script>
</body>
</html>
