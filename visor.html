<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector 3D Pro | CapitanBlue</title>
    
    <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        :root {
            --accent: #00d4ff;
            --panel-bg: rgba(10, 10, 15, 0.9);
            --glass: rgba(255, 255, 255, 0.05);
            --grad: radial-gradient(circle at 50% 40%, #1a1a2e 0%, #050508 100%);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--grad); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }

        model-viewer { width: 100%; height: 100vh; --poster-color: transparent; }

        /* HEADER */
        .header { position: absolute; top: 0; width: 100%; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-sizing: border-box; pointer-events: none; }
        .header * { pointer-events: auto; }
        .back-link { text-decoration: none; color: #888; font-size: 0.8rem; letter-spacing: 1px; transition: 0.3s; }
        .back-link:hover { color: var(--accent); }

        /* PANEL LATERAL (Inspector) */
        .inspector {
            position: absolute; right: 20px; top: 80px; width: 260px;
            background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 20px; backdrop-filter: blur(20px);
            z-index: 100; transform: translateX(300px); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .inspector.open { transform: translateX(0); }

        .inspector h4 { margin: 0 0 15px 0; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        
        .control-group { margin-bottom: 20px; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 8px; color: #ccc; }
        
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }

        /* BOTONES DE MODO */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-mode { 
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1); 
            color: white; padding: 8px; border-radius: 6px; font-size: 0.65rem; 
            cursor: pointer; transition: 0.3s;
        }
        .btn-mode.active { background: var(--accent); color: black; border-color: var(--accent); font-weight: bold; }

        /* STATS CHIP */
        .stats-chip {
            position: absolute; bottom: 30px; left: 30px;
            background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 8px;
            font-size: 10px; font-family: monospace; color: #00ffaa;
            border-left: 3px solid #00ffaa;
        }

        /* TOGGLE INSPECTOR */
        .toggle-insp {
            position: absolute; right: 20px; top: 20px;
            background: var(--accent); color: black; border: none;
            width: 40px; height: 40px; border-radius: 10px; cursor: pointer; z-index: 110;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-link">← VOLVER AL REPOSITORIO</a>
        <h2 id="model-name" style="margin:0; font-size: 1rem; font-weight: 300;">CARGANDO ASSET...</h2>
    </div>

    <button class="toggle-insp" onclick="document.querySelector('.inspector').classList.toggle('open')">⚙️</button>

    <div class="inspector open">
        <h4>Visualización</h4>
        <div class="control-group">
            <div class="label-row"><span>Modo de Render</span></div>
            <div class="mode-grid">
                <button class="btn-mode active" id="m-final" onclick="setMode('final')">Final</button>
                <button class="btn-mode" id="m-wire" onclick="setMode('wire')">Wireframe</button>
                <button class="btn-mode" id="m-clay" onclick="setMode('clay')">Clay</button>
                <button class="btn-mode" id="m-uv" onclick="setMode('uv')">UV Check</button>
            </div>
        </div>

        <h4>Iluminación</h4>
        <div class="control-group">
            <div class="label-row"><span>Exposición</span> <span id="val-exp">1.0</span></div>
            <input type="range" min="0" max="3" step="0.1" value="1" oninput="updateExp(this.value)">
        </div>

        <div class="control-group">
            <div class="label-row"><span>Rotación Luz</span></div>
            <input type="range" min="0" max="360" value="0" oninput="updateLight(this.value)">
        </div>

        <div id="anim-section" style="display:none">
            <h4>Animación</h4>
            <button class="btn-mode" style="width:100%" onclick="toggleAnim()" id="play-pause">PAUSE</button>
        </div>
    </div>

    <div class="stats-chip" id="stats">
        POLYS: -- | VERTS: --
    </div>

    <model-viewer id="main-visor" 
        src="" 
        camera-controls 
        auto-rotate
        shadow-intensity="1" 
        environment-image="neutral"
        exposure="1"
        interpolation-decay="200"
        interaction-prompt="none">
    </model-viewer>

    <script>
        const viewer = document.querySelector("#main-visor");
        const statsDisplay = document.querySelector("#stats");
        let wireframes = [];
        let originalMaterials = new Map();

        // Cargar Modelo
        const params = new URLSearchParams(window.location.search);
        const model = params.get('model');
        if(model) {
            viewer.src = `modelos/${model}`;
            document.querySelector("#model-name").innerText = model.toUpperCase();
        }

        viewer.addEventListener('load', () => {
            calculateStats();
            setupWireframe();
            
            // Check Animaciones
            if (viewer.availableAnimations.length > 0) {
                document.getElementById('anim-section').style.display = 'block';
                viewer.play();
            }
        });

        function calculateStats() {
            let polys = 0;
            let verts = 0;
            const scene = viewer.model[Object.getOwnPropertySymbols(viewer.model)[0]];
            
            scene.traverse(node => {
                if (node.isMesh) {
                    polys += node.geometry.index ? node.geometry.index.count / 3 : node.geometry.attributes.position.count / 3;
                    verts += node.geometry.attributes.position.count;
                }
            });
            statsDisplay.innerText = `POLYS: ${Math.round(polys).toLocaleString()} | VERTS: ${Math.round(verts).toLocaleString()}`;
        }

        function setupWireframe() {
            const scene = viewer.model[Object.getOwnPropertySymbols(viewer.model)[0]];
            wireframes = [];
            scene.traverse(node => {
                if (node.isMesh) {
                    const geo = new THREE.WireframeGeometry(node.geometry);
                    const mat = new THREE.LineBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.5 });
                    const wire = new THREE.LineSegments(geo, mat);
                    node.add(wire);
                    wire.visible = false;
                    wireframes.push(wire);
                }
            });
        }

        function setMode(mode) {
            // Reset botones
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById(`m-${mode === 'final' ? 'final' : mode === 'wire' ? 'wire' : mode === 'clay' ? 'clay' : 'uv'}`).classList.add('active');

            const materials = viewer.model.materials;
            
            wireframes.forEach(w => w.visible = (mode === 'wire'));

            materials.forEach((mat, idx) => {
                if (!originalMaterials.has(idx)) originalMaterials.set(idx, mat.pbrMetallicRoughness.baseColorFactor);
                
                if (mode === 'clay') {
                    mat.pbrMetallicRoughness.setBaseColorFactor([0.7, 0.7, 0.7, 1]);
                    mat.setMetallicFactor(0);
                } else if (mode === 'uv') {
                    mat.pbrMetallicRoughness.setBaseColorFactor([0, 1, 1, 1]);
                } else {
                    mat.pbrMetallicRoughness.setBaseColorFactor(originalMaterials.get(idx));
                    mat.setMetallicFactor(1);
                }
            });
        }

        function updateExp(val) {
            viewer.exposure = val;
            document.getElementById('val-exp').innerText = val;
        }

        function updateLight(val) {
            viewer.setAttribute('rotation', `0deg 0deg ${val}deg`);
        }

        function toggleAnim() {
            const btn = document.getElementById('play-pause');
            if (btn.innerText === "PAUSE") {
                viewer.pause();
                btn.innerText = "PLAY";
            } else {
                viewer.play();
                btn.innerText = "PAUSE";
            }
        }
    </script>
</body>
</html>
