<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapitanBlue | Pro Inspector</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --accent: #00d4ff; --glass: rgba(15, 15, 18, 0.9); --border: rgba(255, 255, 255, 0.1); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050508; font-family: sans-serif; overflow: hidden; color: white; }

        model-viewer { width: 100%; height: 100vh; background: radial-gradient(circle, #1a1a2e 0%, #050508 100%); }

        /* Controles Flotantes Inferiores */
        .bottom-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: var(--glass); padding: 8px;
            border-radius: 50px; border: 1px solid var(--border); z-index: 100;
        }

        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: transparent; color: white; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: var(--accent); color: black; }

        /* Panel de Animaciones */
        #anim-container {
            position: absolute; top: 80px; left: 20px; background: var(--glass);
            padding: 15px; border-radius: 12px; border: 1px solid var(--border);
            display: none; flex-direction: column; gap: 8px; min-width: 150px;
        }

        /* Anotaciones (Hotspots) */
        .Hotspot {
            background: var(--accent); border-radius: 32px; border: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); width: 20px; height: 20px; cursor: pointer;
        }
        .HotspotAnnotation {
            background: #fff; color: #000; border-radius: 4px; padding: 8px;
            position: absolute; transform: translate(10px, 10px); width: 150px;
            display: none; font-size: 12px; font-weight: bold;
        }
        .Hotspot:not([data-visible]) { background: transparent; border: 3px solid white; }
        .Hotspot:focus + .HotspotAnnotation { display: block; }

        /* Info Labels */
        .top-left { position: absolute; top: 20px; left: 20px; }
        .top-left h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        
        .loading-screen {
            position: absolute; inset: 0; background: #050508; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-screen">
        <div class="fa-3x"><i class="fas fa-circle-notch fa-spin" style="color: var(--accent)"></i></div>
        <p id="progress-text">CARGANDO GEOMETRÍA...</p>
    </div>

    <div class="top-left">
        <h1 id="model-title">MODELO 3D</h1>
        <small style="color: var(--accent)">BY CAPITANBLUE</small>
    </div>

    <div id="anim-container">
        <label style="font-size: 10px; color: #888; font-weight: bold;">ANIMACIONES</label>
        <select id="anim-selector" style="background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 4px;"></select>
    </div>

    <model-viewer id="viewer" 
        src="" 
        camera-controls 
        auto-rotate 
        shadow-intensity="1.5" 
        environment-image="neutral"
        exposure="1"
        loading="eager"
        ar
        draco-decoder-path="https://www.gstatic.com/draco/versioned/decoders/1.5.6/">
        
        <button class="Hotspot" slot="hotspot-1" data-position="0m 1.5m 0m" data-normal="0m 0m 1m">
            <div class="HotspotAnnotation">Punto de interés: Revisar topología aquí.</div>
        </button>

    </model-viewer>

    <div class="bottom-bar">
        <button class="icon-btn" onclick="location.href='index.html'" title="Volver"><i class="fas fa-home"></i></button>
        <button class="icon-btn" id="btn-play" title="Play/Pause Animación"><i class="fas fa-play"></i></button>
        <button class="icon-btn" onclick="toggleWireframe()" title="Wireframe"><i class="fas fa-border-none"></i></button>
        <button class="icon-btn" onclick="takeScreenshot()" title="Captura de Pantalla"><i class="fas fa-camera"></i></button>
        <button class="icon-btn" onclick="document.querySelector('#viewer').autoRotate = !document.querySelector('#viewer').autoRotate" title="Girar"><i class="fas fa-sync"></i></button>
    </div>

    <script>
        const viewer = document.getElementById('viewer');
        const params = new URLSearchParams(window.location.search);
        const modelUrl = params.get('model');
        const animContainer = document.getElementById('anim-container');
        const animSelector = document.getElementById('anim-selector');

        if(modelUrl) {
            viewer.src = modelUrl;
            document.getElementById('model-title').innerText = modelUrl.split('/').pop().replace('.glb', '');
        }

        // Manejo de Carga
        viewer.addEventListener('progress', (e) => {
            const p = Math.round(e.detail.totalProgress * 100);
            document.getElementById('progress-text').innerText = `DESCARGANDO: ${p}%`;
        });

        viewer.addEventListener('load', () => {
            document.getElementById('loader').style.display = 'none';
            
            // 1. Cargar Animaciones si existen
            const names = viewer.availableAnimations;
            if (names.length > 0) {
                animContainer.style.display = 'flex';
                animSelector.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');
                viewer.animationName = names[0];
                viewer.play();
            }
        });

        // 2. Control de Animaciones
        animSelector.addEventListener('change', () => {
            viewer.animationName = animSelector.value;
            viewer.play();
        });

        document.getElementById('btn-play').addEventListener('click', () => {
            if(viewer.paused) { viewer.play(); } else { viewer.pause(); }
        });

        // 3. Captura de pantalla
        async function takeScreenshot() {
            const blob = await viewer.toBlob({ idealAspect: true });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Render_${document.getElementById('model-title').innerText}.png`;
            a.click();
        }

        // 4. Wireframe Toggle
        let isWire = false;
        function toggleWireframe() {
            isWire = !isWire;
            const scene = viewer.toObject3D();
            scene.traverse((obj) => {
                if (obj.isMesh) {
                    obj.material.wireframe = isWire;
                }
            });
        }
    </script>
</body>
</html>
