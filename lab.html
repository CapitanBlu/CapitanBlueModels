<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capitan-Lab | Aether Engine Full</title>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --b-dark: #121212; --b-panel: #282828; --b-header: #3d3d3d; --b-accent: #e58d2a; }
        body, html { margin: 0; padding: 0; height: 100%; background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .app-container { display: grid; grid-template-columns: 70px 1fr 280px; grid-template-rows: 40px 1fr 30px; height: 100vh; }
        header { grid-column: 1 / 4; background: var(--b-header); display: flex; align-items: center; padding: 0 15px; border-bottom: 2px solid #111; justify-content: space-between; }
        .toolbar { background: var(--b-panel); display: flex; flex-direction: column; align-items: center; border-right: 1px solid #111; gap: 15px; padding-top: 15px;}
        .tool-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; color: #888; transition: 0.2s; font-size: 1.2rem; }
        .tool-icon.active { background: var(--b-accent); color: black; }
        #viewport { position: relative; background: #333; cursor: crosshair; }
        .sidebar { background: var(--b-panel); border-left: 1px solid #111; padding: 15px; overflow-y: auto; }
        .p-title { font-size: 10px; color: var(--b-accent); text-transform: uppercase; margin: 15px 0 5px 0; font-weight: bold; }
        .b-btn { background: #444; border: 1px solid #555; color: white; width: 100%; padding: 8px; border-radius: 4px; cursor: pointer; margin-bottom: 5px; font-size: 11px; }
        .b-btn:active { background: var(--b-accent); }
        .b-input { background: #1a1a1a; border: 1px solid #000; color: #fff; width: 100%; padding: 5px; margin-bottom: 10px; }
        footer { grid-column: 1 / 4; background: #222; padding: 5px 15px; font-size: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div style="font-weight:900;">CAPITAN-LAB <span id="status" style="color:var(--b-accent); font-weight:normal; margin-left:10px;">IDLE</span></div>
        <button class="b-btn" style="width:auto; background:var(--b-accent); color:black; border:none;" onclick="exportOBJ()">EXPORT .OBJ</button>
    </header>

    <div class="toolbar">
        <div class="tool-icon active" id="mode-layout" onclick="setAppMode('layout')"><i class="fas fa-arrows-alt"></i></div>
        <div class="tool-icon" id="mode-sculpt" onclick="setAppMode('sculpt')"><i class="fas fa-hand-rock"></i></div>
        <div class="tool-icon" id="mode-paint" onclick="setAppMode('paint')"><i class="fas fa-paint-brush"></i></div>
        <div class="tool-icon" id="mode-rig" onclick="setAppMode('rig')"><i class="fas fa-bone"></i></div>
    </div>

    <div id="viewport"></div>

    <div class="sidebar">
        <div class="p-title">Geometry</div>
        <button class="b-btn" onclick="spawn('cube')">Add Cube</button>
        <button class="b-btn" onclick="spawn('sphere')">Add Sphere</button>
        
        <div id="panel-sculpt" style="display:none;">
            <div class="p-title">Sculpt Tool</div>
            <label>Size</label><input type="range" id="sculpt-size" min="0.1" max="1" step="0.05" value="0.3" class="b-input">
            <label>Strength</label><input type="range" id="sculpt-strength" min="0.01" max="0.2" step="0.01" value="0.05" class="b-input">
            <button class="b-btn" onclick="sculptMode='inflate'">Inflate</button>
            <button class="b-btn" onclick="sculptMode='deflate'">Deflate</button>
        </div>

        <div id="panel-paint" style="display:none;">
            <div class="p-title">Paint Tool</div>
            <input type="color" id="brush-color" value="#e58d2a" class="b-input">
            <button class="b-btn" onclick="paintAll()">Fill All</button>
        </div>

        <div class="p-title">Outliner</div>
        <div id="outliner" style="background:#111; height:100px; padding:5px; font-size:10px;"></div>
    </div>

    <footer>
        Verts: <span id="v-info">0</span> | Faces: <span id="f-info">0</span> | Engine: Three.js Core
    </footer>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { OBJExporter } from 'three/addons/exporters/OBJExporter.js';

    let scene, camera, renderer, orbit, transform;
    let currentMode = 'layout';
    let sculptMode = 'inflate';
    let meshes = [];
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    init();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        const container = document.getElementById('viewport');
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        orbit = new OrbitControls(camera, renderer.domElement);
        transform = new TransformControls(camera, renderer.domElement);
        scene.add(transform);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        scene.add(light);
        scene.add(new THREE.GridHelper(10, 10, 0x444444, 0x222222));

        // Eventos
        container.addEventListener('mousedown', onMouseDown);
        container.addEventListener('mousemove', onMouseMove);
        
        spawn('cube');
        animate();
    }

    // MODO APP
    window.setAppMode = function(m) {
        currentMode = m;
        document.querySelectorAll('.tool-icon').forEach(i => i.classList.remove('active'));
        document.getElementById('mode-' + m).classList.add('active');
        document.getElementById('panel-sculpt').style.display = (m === 'sculpt') ? 'block' : 'none';
        document.getElementById('panel-paint').style.display = (m === 'paint') ? 'block' : 'none';
        document.getElementById('status').innerText = m.toUpperCase();
        
        if(m !== 'layout') transform.detach();
        else if(meshes.length > 0) transform.attach(meshes[meshes.length-1]);
    };

    // SPAWN
    window.spawn = function(type) {
        const geo = type === 'cube' ? new THREE.BoxGeometry(1.5,1.5,1.5, 20, 20, 20) : new THREE.SphereGeometry(1, 32, 32);
        const mat = new THREE.MeshStandardMaterial({ color: 0x888888, vertexColors: true });
        const mesh = new THREE.Mesh(geo, mat);
        
        // Inicializar colores de v√©rtices para Paint
        const count = geo.attributes.position.count;
        geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count * 3), 3));
        for(let i=0; i<count*3; i++) geo.attributes.color.array[i] = 1;

        scene.add(mesh);
        meshes.push(mesh);
        transform.attach(mesh);
        updateOutliner();
    };

    // ESCULTURA Y PINTURA REAL
    function onMouseMove(event) {
        if (event.buttons !== 1 || currentMode === 'layout') return;

        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(meshes);

        if (intersects.length > 0) {
            const hit = intersects[0];
            const mesh = hit.object;
            const posAttr = mesh.geometry.attributes.position;
            const colorAttr = mesh.geometry.attributes.color;
            const localHit = mesh.worldToLocal(hit.point.clone());

            const radius = parseFloat(document.getElementById('sculpt-size').value);
            const strength = parseFloat(document.getElementById('sculpt-strength').value);
            const paintCol = new THREE.Color(document.getElementById('brush-color').value);

            for (let i = 0; i < posAttr.count; i++) {
                const vertex = new THREE.Vector3().fromBufferAttribute(posAttr, i);
                const dist = vertex.distanceTo(localHit);

                if (dist < radius) {
                    const falloff = (1 - dist / radius);
                    
                    if (currentMode === 'sculpt') {
                        const normal = new THREE.Vector3().fromBufferAttribute(mesh.geometry.attributes.normal, i);
                        const move = strength * falloff;
                        if (sculptMode === 'inflate') vertex.addScaledVector(normal, move);
                        else vertex.addScaledVector(normal, -move);
                        posAttr.setXYZ(i, vertex.x, vertex.y, vertex.z);
                    } 
                    else if (currentMode === 'paint') {
                        colorAttr.setXYZ(i, paintCol.r, paintCol.g, paintCol.b);
                    }
                }
            }
            posAttr.needsUpdate = true;
            if (colorAttr) colorAttr.needsUpdate = true;
            if (currentMode === 'sculpt') mesh.geometry.computeVertexNormals();
        }
    }

    function onMouseDown(e) { if(currentMode === 'layout') orbit.enabled = true; else orbit.enabled = false; }

    window.exportOBJ = function() {
        const exporter = new OBJExporter();
        const data = exporter.parse(scene);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([data], {type:'text/plain'}));
        link.download = 'capitan_lab_export.obj';
        link.click();
    };

    function updateOutliner() {
        document.getElementById('outliner').innerHTML = meshes.map((m, i) => `<div><i class="fas fa-cube"></i> Mesh_${i}</div>`).join('');
        const last = meshes[meshes.length-1];
        document.getElementById('v-info').innerText = last.geometry.attributes.position.count;
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
